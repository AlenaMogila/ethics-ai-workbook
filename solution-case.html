// Функция автосохранения
function saveToLocalStorage() {
    const formData = {
        algorithmSolution: document.getElementById('algorithm-solution').value,
        ethicalPrinciples: document.getElementById('ethical-principles').value,
        protectionMeasures: document.getElementById('protection-measures').value,
        monitoringSystem: document.getElementById('monitoring-system').value,
        difficulty: document.querySelector('input[name="difficulty"]:checked')?.value || '',
        difficultAspect: document.getElementById('difficult-aspect').value,
        opinionChange: document.getElementById('opinion-change').value,
        remainingQuestions: document.getElementById('remaining-questions').value
    };
    localStorage.setItem('ethicsWorkbookSolution', JSON.stringify(formData));
    updateProgress();
    
    // Показываем индикатор автосохранения
    autoSaveIndicator.classList.add('show');
    setTimeout(() => {
        autoSaveIndicator.classList.remove('show');
    }, 2000);
}

// Функция загрузки из localStorage
function loadFromLocalStorage() {
    const saved = localStorage.getItem('ethicsWorkbookSolution');
    if (saved) {
        const data = JSON.parse(saved);
        document.getElementById('algorithm-solution').value = data.algorithmSolution || '';
        document.getElementById('ethical-principles').value = data.ethicalPrinciples || '';
        document.getElementById('protection-measures').value = data.protectionMeasures || '';
        document.getElementById('monitoring-system').value = data.monitoringSystem || '';
        document.getElementById('difficult-aspect').value = data.difficultAspect || '';
        document.getElementById('opinion-change').value = data.opinionChange || '';
        document.getElementById('remaining-questions').value = data.remainingQuestions || '';
        
        if (data.difficulty) {
            const difficultyRadio = document.querySelector(`input[name="difficulty"][value="${data.difficulty}"]`);
            if (difficultyRadio) difficultyRadio.checked = true;
        }
    }
    updateProgress();
}

// Функция генерации PDF с поддержкой кириллицы
function generatePDF() {
    // Collect all answers
    const answers = {
        algorithmSolution: document.getElementById('algorithm-solution').value,
        ethicalPrinciples: document.getElementById('ethical-principles').value,
        protectionMeasures: document.getElementById('protection-measures').value,
        monitoringSystem: document.getElementById('monitoring-system').value,
        difficulty: document.querySelector('input[name="difficulty"]:checked')?.value || '',
        difficultAspect: document.getElementById('difficult-aspect').value,
        opinionChange: document.getElementById('opinion-change').value,
        remainingQuestions: document.getElementById('remaining-questions').value
    };

    // Check if at least some answers are provided
    const hasAnswers = Object.values(answers).some(value => value && value.trim());

    if (!hasAnswers) {
        alert('Пожалуйста, заполните хотя бы один ответ перед сохранением.');
        return;
    }

    // Create PDF with proper Cyrillic support
    const doc = new jsPDF();
    
    // Add Cyrillic font support
    doc.setFont('helvetica'); // Используем стандартный шрифт, который поддерживает кириллицу
    
    // Title
    doc.setFontSize(20);
    doc.text('Этика ИИ: Решение и рефлексия', 20, 30);
    
    // Subtitle
    doc.setFontSize(14);
    doc.text('Кейс: Таргетированная реклама', 20, 40);
    
    // Date
    doc.setFontSize(12);
    const date = new Date().toLocaleDateString('ru-RU');
    doc.text(`Дата: ${date}`, 20, 50);
    
    let yPosition = 65;
    
    // Solutions section
    doc.setFontSize(14);
    doc.text('ПРЕДЛОЖЕННЫЕ РЕШЕНИЯ', 20, yPosition);
    yPosition += 15;
    
    // Algorithm solution
    if (answers.algorithmSolution) {
        doc.setFontSize(12);
        doc.text('1. Изменения алгоритма:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const lines1 = doc.splitTextToSize(answers.algorithmSolution, 170);
        doc.text(lines1, 20, yPosition);
        yPosition += lines1.length * 5 + 10;
    }
    
    // Check if we need a new page
    if (yPosition > 250) {
        doc.addPage();
        yPosition = 30;
    }
    
    // Ethical principles
    if (answers.ethicalPrinciples) {
        doc.setFontSize(12);
        doc.text('2. Этические принципы:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const lines2 = doc.splitTextToSize(answers.ethicalPrinciples, 170);
        doc.text(lines2, 20, yPosition);
        yPosition += lines2.length * 5 + 10;
    }
    
    // Protection measures
    if (answers.protectionMeasures) {
        if (yPosition > 230) {
            doc.addPage();
            yPosition = 30;
        }
        doc.setFontSize(12);
        doc.text('3. Защита уязвимых групп:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const lines3 = doc.splitTextToSize(answers.protectionMeasures, 170);
        doc.text(lines3, 20, yPosition);
        yPosition += lines3.length * 5 + 10;
    }
    
    // Monitoring system
    if (answers.monitoringSystem) {
        if (yPosition > 230) {
            doc.addPage();
            yPosition = 30;
        }
        doc.setFontSize(12);
        doc.text('4. Система контроля:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const lines4 = doc.splitTextToSize(answers.monitoringSystem, 170);
        doc.text(lines4, 20, yPosition);
        yPosition += lines4.length * 5 + 15;
    }
    
    // Reflection section
    if (yPosition > 200) {
        doc.addPage();
        yPosition = 30;
    }
    
    doc.setFontSize(14);
    doc.text('РЕФЛЕКСИЯ', 20, yPosition);
    yPosition += 15;
    
    // Difficulty rating
    if (answers.difficulty) {
        doc.setFontSize(12);
        doc.text('Сложность задания:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const difficultyLabels = {
            '1': 'Очень легко',
            '2': 'Легко', 
            '3': 'Средне',
            '4': 'Сложно',
            '5': 'Очень сложно'
        };
        doc.text(difficultyLabels[answers.difficulty] || answers.difficulty, 20, yPosition);
        yPosition += 15;
    }
    
    // Difficult aspect
    if (answers.difficultAspect) {
        if (yPosition > 230) {
            doc.addPage();
            yPosition = 30;
        }
        doc.setFontSize(12);
        doc.text('Самое трудное в анализе:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const lines5 = doc.splitTextToSize(answers.difficultAspect, 170);
        doc.text(lines5, 20, yPosition);
        yPosition += lines5.length * 5 + 10;
    }
    
    // Opinion change
    if (answers.opinionChange) {
        if (yPosition > 240) {
            doc.addPage();
            yPosition = 30;
        }
        doc.setFontSize(12);
        doc.text('Изменение мнения:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const opinionLabels = {
            'yes-positive': 'Да, стал относиться более позитивно',
            'yes-negative': 'Да, стал относиться более критично',
            'no': 'Нет, мнение не изменилось',
            'complex': 'Мнение стало более сложным и нюансированным'
        };
        doc.text(opinionLabels[answers.opinionChange] || answers.opinionChange, 20, yPosition);
        yPosition += 15;
    }
    
    // Remaining questions
    if (answers.remainingQuestions) {
        if (yPosition > 230) {
            doc.addPage();
            yPosition = 30;
        }
        doc.setFontSize(12);
        doc.text('Оставшиеся вопросы:', 20, yPosition);
        yPosition += 8;
        doc.setFontSize(10);
        const lines6 = doc.splitTextToSize(answers.remainingQuestions, 170);
        doc.text(lines6, 20, yPosition);
    }
    
    // Save the PDF
    doc.save('Этика_ИИ_Решение_и_Рефлексия.pdf');
    
    // Show success message
    showSuccessMessage();
}

// Инициализация при загрузке DOM
document.addEventListener('DOMContentLoaded', function() {
    loadFromLocalStorage();
    
    // Добавляем автосохранение для всех элементов формы
    const formElements = document.querySelectorAll('textarea, input, select');
    formElements.forEach(element => {
        element.addEventListener('input', saveToLocalStorage);
        element.addEventListener('change', saveToLocalStorage);
    });
    
    // Назначаем обработчики кнопок
    savePdfButton.addEventListener('click', generatePDF);
    resetFormButton.addEventListener('click', resetForm);
    
    // Добавляем обработчики для радио-кнопок
    document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
        radio.addEventListener('change', saveToLocalStorage);
    });
    
    // Добавляем обработчик для select
    document.getElementById('opinion-change').addEventListener('change', saveToLocalStorage);
});
